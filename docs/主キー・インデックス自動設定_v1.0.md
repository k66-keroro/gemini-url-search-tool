# 主キー・インデックス自動設定機能 v1.0

## 概要

全データ更新処理の最終段階で、全テーブルに対して主キーとインデックスを自動設定する機能です。

## 主要機能

### 1. 主キー自動設定

- **_rowid_カラム追加**: 主キーが未設定のテーブルに自動追加
- **AUTO INCREMENT**: 自動増分の整数型主キー
- **重複チェック**: 既存の主キーがある場合はスキップ

### 2. インデックス自動作成

#### 主キー候補パターン
- `id`, `_id`, `key`, `_key`
- `no`, `_no`, `code`, `_code`
- `コード`, `番号`, `キー`

#### インデックス候補パターン
- `date`, `日付`, `time`, `時刻`
- `created`, `updated`, `作成`, `更新`, `登録`
- `status`, `状態`

### 3. データベース最適化

- **PRAGMA optimize**: SQLiteの内部最適化を実行
- **統計情報更新**: クエリプランナーの最適化

## 実装詳細

### finalize_databaseメソッド

```python
def finalize_database(self, db_path: str = None):
    """データベースの最終化処理（主キー・インデックス設定）"""
    
    # 全テーブル一覧を取得
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'")
    tables = cursor.fetchall()
    
    for table_name in tables:
        # 主キー設定
        if not has_primary_key(table_name):
            cursor.execute(f"ALTER TABLE `{table_name}` ADD COLUMN _rowid_ INTEGER PRIMARY KEY AUTOINCREMENT")
        
        # インデックス作成
        for col_name in get_index_candidates(table_name):
            index_name = f"idx_{table_name}_{col_name}"
            cursor.execute(f"CREATE INDEX `{index_name}` ON `{table_name}`(`{col_name}`)")
    
    # データベース最適化
    cursor.execute("PRAGMA optimize")
```

### 処理フロー

1. **テーブル一覧取得**: システムテーブルを除く全テーブルを取得
2. **テーブル情報分析**: 各テーブルのカラム情報を取得
3. **主キー確認**: 既存の主キーをチェック
4. **主キー追加**: 未設定の場合は_rowid_を追加
5. **インデックス候補抽出**: カラム名パターンマッチング
6. **インデックス作成**: 重複チェック後に作成
7. **最適化実行**: PRAGMA optimizeを実行

## ログ出力例

```
インデックスとキーの設定を開始...
主キー追加: zp138._rowid_
主キー追加: zm29._rowid_
インデックス作成: idx_zp138_品目コード
インデックス作成: idx_zm29_品目
インデックス作成: idx_zm29_登録日
インデックス作成: idx_zs65_品目コード
インデックス作成: idx_zs65_日付
データベース最終化完了: 15テーブル処理, 23インデックス作成
インデックスとキーの設定が完了しました（3.45秒）
```

## パフォーマンス効果

### 1. クエリ高速化

- **WHERE句**: インデックス付きカラムでの検索が高速化
- **JOIN操作**: 結合キーにインデックスがあることで高速化
- **ORDER BY**: ソート処理の高速化

### 2. データ整合性

- **主キー制約**: 重複レコードの防止
- **一意性保証**: データの整合性向上

### 3. Access連携

- **型統一**: 主キーによる安全なリレーション
- **パフォーマンス**: インデックスによる高速アクセス

## エラーハンドリング

### 1. 主キー追加エラー

```python
try:
    cursor.execute(f"ALTER TABLE `{table_name}` ADD COLUMN _rowid_ INTEGER PRIMARY KEY AUTOINCREMENT")
except sqlite3.OperationalError as e:
    if "duplicate column name" not in str(e).lower():
        self.logger.warning(f"主キー追加失敗: {table_name} - {e}")
```

### 2. インデックス作成エラー

```python
try:
    cursor.execute(f"CREATE INDEX `{index_name}` ON `{table_name}`(`{col_name}`)")
except Exception as e:
    self.logger.warning(f"インデックス作成失敗: {index_name} - {e}")
```

## 設定カスタマイズ

### 1. 主キー候補パターン

```python
pk_patterns = ['id', '_id', 'key', '_key', 'no', '_no', 'code', '_code', 
               'コード', '番号', 'キー']
```

### 2. インデックス候補パターン

```python
idx_patterns = ['date', '日付', 'time', '時刻', 'created', 'updated', 
                '作成', '更新', '登録', 'status', '状態']
```

## 今後の拡張

1. **設定ファイル化**: パターンを外部設定ファイルで管理
2. **複合インデックス**: 複数カラムでのインデックス作成
3. **パフォーマンス分析**: インデックス効果の測定
4. **自動メンテナンス**: 定期的なインデックス再構築