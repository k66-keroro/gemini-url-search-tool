# コードフィールド変換機能

## 概要

コードフィールド変換機能は、SQLiteデータベース内の数値型（REAL/INTEGER）として保存されているコードフィールドを文字列型（TEXT）に変換するための機能です。この変換により、以下の問題を解決します：

1. **先頭の0が削除される問題**
   - 例：コード「001」が「1」として保存される問題を解決

2. **SAPの後ろマイナス表記の問題**
   - 例：「1234-」のような表記が正しく扱われるようになる

3. **テーブル間の結合時のデータ型不一致の問題**
   - REALとINTEGERが混在する問題を解決し、結合操作が正確になる

## 使用方法

### GUIツールでの使用方法

1. SQLite GUI Toolを起動
   ```
   python src/core/sqlite_gui_tool_v2_fixed.py
   ```

2. 「データベース接続」ボタンをクリックしてSQLiteデータベースを選択

3. 「コードフィールド変換」タブを選択

4. 「変換対象フィールドを分析」ボタンをクリックして、変換候補を表示

5. 変換したいフィールドにチェックを入れる（「全て選択」「全て解除」ボタンも利用可能）

6. 「選択したフィールドを変換」ボタンをクリックして変換を実行

### コマンドラインツールでの使用方法

```bash
# ドライラン（変換対象の確認のみ）
python src/tools/fix_numeric_codes.py data/sqlite/main.db --dry-run

# 実際に変換を実行
python src/tools/fix_numeric_codes.py data/sqlite/main.db

# 特定のテーブルのみを処理
python src/tools/fix_numeric_codes.py data/sqlite/main.db --tables zp138,zs65,zm21

# ログファイルを指定
python src/tools/fix_numeric_codes.py data/sqlite/main.db --log-file logs/fix_codes.log
```

## 変換対象の判定基準

システムは以下の基準でフィールドを分析し、文字列型に変換すべきかを判断します：

1. **コードフィールドの特定**
   - フィールド名に「code」「コード」「番号」「id」「no」「number」などを含む
   - 「伝票」「受注」「発注」「購買」「指図」「品目」「wbs」「ネットワーク」「得意先」「勘定」「保管場所」「評価クラス」などの業務用語を含む

2. **値の分析**
   - 先頭に0が付いている値がある（例: 001, 0123）
   - 固定桁数の数値が多い（全体の80%以上が同じ桁数）
   - SAPの後ろマイナス表記（例: 1234-）がある

## 変換処理の仕組み

1. テーブルの構造を取得
2. 一時テーブルを作成してデータをコピー
3. 元のテーブルを削除
4. 対象カラムのデータ型をTEXTに変更して新しいテーブルを作成
5. 一時テーブルからデータをコピー（対象カラムはCASTを使用して文字列に変換）
6. 一時テーブルを削除

## 注意事項

- 変換前にデータベースのバックアップを作成することを推奨します
- 大規模なデータベースの場合、処理に時間がかかる場合があります
- インデックスや外部キー制約は自動的に再作成されます
- 変換後はアプリケーションが正常に動作するか確認してください