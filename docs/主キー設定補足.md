# 主キー設定に関する補足情報

## 現状の課題

テーブルにする元データがマスタばかりでは無く情シス作成の最終資料が多数あります。
しかし最終資料がユーザーが使用するにはデータ不足が多数あるために2次加工のためにSQLite格納を試みてます。
上記の状態なので基本のデータベースの概念にそぐわない事が発生します。
主キーがその一つです。フィールドにユニークなデータが無い元データがあるのです。
対処として全データにオートナンバーを主キー設定しユニークなフィールドがるものはそれをインデックスとする方針で進めてます。

## 現在の方針の妥当性

現在採用している「オートナンバーを主キーとし、ユニークなフィールドがあればインデックスを設定する」という方針は、以下の理由から適切な対応と言えます：

1. **データの整合性確保**: オートナンバー（INTEGER PRIMARY KEY）を使用することで、各レコードを一意に識別できます
2. **検索パフォーマンスの向上**: 実際のビジネスキーにインデックスを設定することで、検索速度を向上させられます
3. **柔軟性の確保**: 元データの構造に依存せず、一貫した方法でデータベースを構築できます
4. **将来の拡張性**: 新しいデータソースが追加された場合でも、同じ方針で対応できます

## 代替案と補足提案

### 1. 複合キーによるユニーク制約の検討

一部のテーブルでは、単一フィールドではユニークでなくても、複数フィールドの組み合わせがユニークになる場合があります。例えば：

```sql
CREATE TABLE kousu_jisseki (
    "_rowid_" INTEGER PRIMARY KEY AUTOINCREMENT,
    "指図番号" TEXT,
    "確認番号" TEXT,
    -- 他のフィールド...
    UNIQUE("指図番号", "確認番号")
);
```

このように、UNIQUE制約を追加することで、データの整合性をさらに高めることができます。

### 2. ビュー（VIEW）の活用

複数のテーブルを結合して使用することが多い場合、ビューを作成することで、利便性を向上させることができます：

```sql
CREATE VIEW v_kousu_jisseki_with_master AS
SELECT 
    k.*,
    m.品目テキスト,
    m.プラント
FROM 
    kousu_jisseki k
LEFT JOIN 
    mara_dl m ON k.品目コード = m.品目;
```

### 3. トリガーによるデータ整合性の確保

データ更新時に特定の処理を行いたい場合、トリガーを使用することができます：

```sql
CREATE TRIGGER update_timestamp
AFTER UPDATE ON kousu_jisseki
FOR EACH ROW
BEGIN
    UPDATE kousu_jisseki 
    SET 更新日時 = CURRENT_TIMESTAMP
    WHERE _rowid_ = NEW._rowid_;
END;
```

### 4. 段階的なデータ品質向上アプローチ

1. **第1段階**: 現在の方針通り、オートナンバー主キー + インデックスで実装
2. **第2段階**: データ分析を通じて、ビジネスルールや制約を特定
3. **第3段階**: 特定したルールに基づいて、UNIQUE制約やCHECK制約を追加
4. **第4段階**: 必要に応じてビューやトリガーを追加し、データの利便性と整合性を向上

## 結論

現在の「オートナンバーを主キーとし、ユニークなフィールドにインデックスを設定する」という方針は、データの特性を考慮すると適切な選択です。特に2次加工を目的としたデータベースでは、この方針によって柔軟性と拡張性を確保できます。

将来的には、データの利用パターンや要件に応じて、複合ユニーク制約、ビュー、トリガーなどを段階的に導入することで、データベースの品質と利便性をさらに向上させることができるでしょう。

## 次のステップ

1. `src/core/sqlite_manager_fixed.py` を使用して、全テーブルにオートナンバー主キーを設定
2. `config/index_definitions.txt` に基づいて、適切なインデックスを作成
3. データの利用パターンを分析し、必要に応じてビューを作成
4. 将来的なデータ品質向上のためのロードマップを作成

現状accessで処理している事をPython+SQLiteでダッシュボード+資料をExcel、Django、またはStreamlitで出力する計画は、この方針と整合性があり、適切なアプローチと言えます。