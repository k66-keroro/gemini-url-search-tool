# SQLiteテーブルの主キーとインデックスの設定方法

## 概要

このドキュメントでは、SQLiteデータベースのテーブルに主キーとインデックスを設定する方法について説明します。

## 1. 定義ファイル

### 主キーとインデックスの定義ファイル

主キーとインデックスの定義は同じファイル形式で管理されています：

- ファイル: `config/index_definitions.txt`
- 形式: タブ区切りテキストファイル
- 列構成:
  - `Table Name`: テーブル名
  - `Field Name`: 主キー/インデックスの1つ目のカラム
  - `Field Name2`: 主キー/インデックスの2つ目のカラム（複合キーの場合）
  - `重複要因ホカ`: 備考（処理には影響しない）

### 定義ファイルの例

```
Table Name	Field Name	Field Name2	重複要因ホカ
getplmitmplntinfo_p100	品目コード		
kousu_jisseki	指図番号	確認番号	複数人
zf26	得意先コード		
```

## 2. 主キーとインデックスの設定方法

### 方法1: 一括適用スクリプトを使用する（推奨）

最も簡単な方法は、一括適用スクリプトを使用することです：

```bash
cd src
python apply_table_optimizations.py
```

このスクリプトは以下の処理を行います：

1. `config/index_definitions.txt` から主キーとインデックスの定義を読み込む
2. データベース内の全テーブルに対して定義を適用する
3. 処理結果をログに出力する

### 方法2: SQLiteManagerクラスを直接使用する

プログラムから直接SQLiteManagerクラスを使用することもできます：

```python
from pathlib import Path
from src.core.sqlite_manager_fixed import SQLiteManager

# SQLiteManagerのインスタンスを作成
db_path = Path("data/sqlite/main.db")
manager = SQLiteManager(db_path)

# 定義ファイルのパス
primary_key_file = Path("config/index_definitions.txt")
index_file = Path("config/index_definitions.txt")

# 最適化を適用
success_count, error_count, error_messages = manager.apply_table_optimizations(
    primary_key_file, index_file
)

print(f"処理完了: 成功={success_count}, 失敗={error_count}")
```

### 方法3: 個別のテーブルに手動で適用する

特定のテーブルにのみ主キーやインデックスを設定したい場合：

```python
import sqlite3
from pathlib import Path
from src.core.sqlite_manager_fixed import SQLiteManager

# SQLiteManagerのインスタンスを作成
db_path = Path("data/sqlite/main.db")
manager = SQLiteManager(db_path)

# データベースに接続
with sqlite3.connect(db_path) as conn:
    # 主キーを設定（例: zm29テーブルの「ネットワーク・指図番号」カラムを主キーに）
    success, error = manager.finalize_table_structure(
        conn, 
        "zm29", 
        primary_key_columns=["ネットワーク・指図番号"],
        index_columns=[]
    )
    
    if success:
        print("主キーの設定に成功しました")
    else:
        print(f"エラー: {error}")
        
    # インデックスを設定（例: zf26テーブルの「得意先コード」カラムにインデックスを作成）
    success, error = manager.finalize_table_structure(
        conn, 
        "zf26", 
        primary_key_columns=None,  # 主キーは設定しない
        index_columns=["得意先コード"]
    )
    
    if success:
        print("インデックスの設定に成功しました")
    else:
        print(f"エラー: {error}")
```

## 3. 主キーとインデックスの設定に関する注意点

### 主キーについて

- 主キーは一意性制約を持ちます（重複値は許可されません）
- 主キーに設定するカラムには NULL 値を含めることができません
- 複合主キーの場合、指定したカラムの組み合わせが一意である必要があります

### インデックスについて

- インデックスは検索速度を向上させますが、挿入・更新速度は低下します
- 頻繁に検索条件として使用されるカラムにインデックスを設定すると効果的です
- 複合インデックスは、複数のカラムを組み合わせた検索に効果的です

### エラーが発生する一般的な原因

1. **重複値の存在**: 主キーに設定しようとしているカラムに重複値がある
2. **NULL値の存在**: 主キーに設定しようとしているカラムにNULL値がある
3. **カラム名の不一致**: 定義ファイルのカラム名とテーブルの実際のカラム名が一致していない
4. **テーブル名の不一致**: 定義ファイルのテーブル名とデータベースの実際のテーブル名が一致していない

## 4. トラブルシューティング

### 主キー設定時のエラー

主キー設定時に「UNIQUE constraint failed」エラーが発生した場合：

1. そのテーブルのデータを確認し、重複値が存在しないか調査する
2. 必要に応じて重複データを統合または削除する
3. 別のカラムを主キーとして選択するか、複合主キーを検討する

### インデックス作成時のエラー

インデックス作成時にエラーが発生した場合：

1. カラム名が正確に一致しているか確認する
2. テーブル内にそのカラムが存在するか確認する
3. インデックス名が既に使用されていないか確認する

### ログの確認

処理中のエラーや詳細情報は以下のログファイルで確認できます：

- `logs/SQLiteManager.log`: SQLiteManagerクラスのログ
- `logs/apply_table_optimizations.log`: 一括適用スクリプトのログ

## 5. 参考情報

- [SQLite公式ドキュメント - ALTER TABLE](https://www.sqlite.org/lang_altertable.html)
- [SQLite公式ドキュメント - CREATE INDEX](https://www.sqlite.org/lang_createindex.html)
- [DB Browser for SQLite](https://sqlitebrowser.org/) - SQLiteデータベースを視覚的に操作できるツール