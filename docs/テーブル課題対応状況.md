# テーブル課題対応状況

## 1. zm37.txtの処理問題

**対応内容**:
- SQLiteManagerクラスにzm37.txt専用の処理を追加
- CP932エンコーディングと特殊な区切り文字に対応
- 読み込み失敗時のエラーハンドリングを強化

**実装箇所**:
- `src/core/sqlite_manager.py` の `bulk_insert_from_file` メソッド

## 2. 特殊なExcelファイルの処理

**対応内容**:
- PP_SUMMARY_ZTBP080_KOJOZISSEKI_D_0.xlsx のヘッダー6行対応を実装
- 7行目をフィールド名として読み込む処理を追加

**実装箇所**:
- `src/core/sqlite_manager.py` の `bulk_insert_from_file` メソッド内のExcel処理部分

## 3. テーブル名の修正

**対応内容**:
- 日本語や特殊文字を含むテーブル名を適切に変換
- 日本語テーブル名には `t_` プレフィックスとハッシュ値を付与
- 特殊文字は `_` に置換
- 先頭が数字の場合は `t_` プレフィックスを付与

**実装箇所**:
- `src/main.py` の `_sanitize_table_name` 関数

## 4. データ型の修正

**対応内容**:
- 日付カラムの自動検出と変換
- 8桁数値の日付形式（YYYYMMDD）の検出と変換
- コードカラムの文字列型保持
- 数値のみのカラムの数値型変換

**実装箇所**:
- `src/core/sqlite_manager.py` の `_optimize_dtypes` メソッド

## 5. 数値型コードフィールドの文字列型への変換

**対応内容**:
- 数値型（REAL/INTEGER）として保存されているコードフィールドを文字列型（TEXT）に変換する機能を実装
- 先頭の0が削除される問題、SAPの後ろマイナス表記の問題、データ型不一致の問題を解決
- GUI操作とコマンドライン操作の両方をサポート

**実装箇所**:
- `src/core/code_field_converter.py` - コードフィールド変換のコア機能
- `src/tools/fix_numeric_codes.py` - コマンドライン用ツール
- `src/core/sqlite_gui_tool_v2_fixed.py` - GUI操作用のコードフィールド変換タブ

## 6. その他の対応

**日付型の扱い**:
- Steeringガイドラインに従い、日付は TEXT 型（ISO8601形式）または INTEGER 型（UNIXタイムスタンプ）で格納
- pandas の datetime 型を使用して変換

**主キーとインデックス**:
- すべてのテーブルに `_rowid_` という自動増分の主キーを追加
- インデックス定義ファイルに基づいてインデックスを作成

## 今後の課題

1. **wbsの親子関係**:
   - フィールド名の統一性の問題は、データ変換時に対応が必要

2. **dbo_提出用_経理_滞留在庫資料_通常.xlsx**:
   - 月初更新（稼働日2日目位）の自動化
   - 年次データと月次データの区別
   - 差分のみの更新処理

3. **パフォーマンス最適化**:
   - 大量データ処理時のメモリ使用量の最適化
   - トランザクション処理の改善