# 数値型コードフィールドの修正ガイド

## 問題の概要

データベース内の多くのコードフィールド（評価クラス、保管場所、勘定科目コード、受注番号など）が数値型（REAL または INTEGER）として保存されていますが、これらは本来文字列型（TEXT）として扱うべきです。

### 数値型で保存する問題点

1. **先頭の0が削除される**
   - 例: コード「001」が「1」として保存される
   - 元データの形式が失われる

2. **SAPの後ろマイナス表記が正しく扱われない**
   - 例: 「1234-」のような表記が数値として解釈できない

3. **テーブル間の結合時にデータ型の不一致が発生する**
   - 同じコードフィールドがテーブルによってREALとINTEGERで混在
   - 結合時に暗黙の型変換が発生し、パフォーマンスや正確性に影響

4. **固定桁数の情報が失われる**
   - コードが固定桁数（例: 8桁）であるべき場合に、桁数の情報が失われる

## 修正ツールの使用方法

`src/tools/fix_numeric_codes.py` を使用して、数値型コードフィールドを文字列型に変換できます。

### 基本的な使用方法

```bash
# ドライラン（変換対象の確認のみ）
python src/tools/fix_numeric_codes.py data/sqlite/main.db --dry-run

# 実際に変換を実行
python src/tools/fix_numeric_codes.py data/sqlite/main.db
```

### オプション

- `--dry-run`: 変換対象を表示するだけで実際の変換は行いません
- `--tables`: 処理対象のテーブルをカンマ区切りで指定します
- `--log-file`: ログの出力先ファイルを指定します

### 使用例

```bash
# 特定のテーブルのみを処理
python src/tools/fix_numeric_codes.py data/sqlite/main.db --tables zp138,zs65,zm21

# ログファイルを指定
python src/tools/fix_numeric_codes.py data/sqlite/main.db --log-file logs/fix_codes.log

# 特定のテーブルのみをドライランで確認
python src/tools/fix_numeric_codes.py data/sqlite/main.db --tables zp138,zs65 --dry-run
```

## 変換対象フィールドの判定基準

ツールは以下の基準でフィールドを分析し、文字列型に変換すべきかを判断します：

1. **コードフィールドの特定**
   - フィールド名に「code」「コード」「番号」「id」「no」「number」などを含む
   - 「伝票」「受注」「発注」「購買」「指図」「品目」「wbs」「ネットワーク」「得意先」「勘定」「保管場所」「評価クラス」などの業務用語を含む

2. **値の分析**
   - 先頭に0が付いている値がある（例: 001, 0123）
   - 固定桁数の数値が多い（全体の80%以上が同じ桁数）
   - SAPの後ろマイナス表記（例: 1234-）がある

## 変換処理の流れ

1. データベース内のすべてのテーブルとカラムを分析
2. コードフィールドの可能性が高いフィールドを特定
3. 各フィールドの値を分析し、文字列型に変換すべきかを判断
4. 変換対象フィールドを文字列型に変換（テーブル再構築）

## 注意事項

- 変換前にデータベースのバックアップを作成することを強く推奨します
- 大規模なデータベースの場合、処理に時間がかかる場合があります
- インデックスや外部キー制約は自動的に再作成されます

## 変換後の確認

変換後は以下の点を確認してください：

1. アプリケーションが正常に動作するか
2. テーブル結合が正しく行われるか
3. 検索条件が正しく機能するか

## よくある質問

### Q: 変換によってデータが失われることはありますか？
A: 変換処理は慎重に行われ、データの内容自体は変更されません。数値型から文字列型への変換は安全に行われます。

### Q: すべてのコードフィールドを変換する必要がありますか？
A: 必ずしもすべてのフィールドを変換する必要はありません。実際の使用状況に応じて判断してください。ドライランモードで変換対象を確認し、必要なフィールドのみを変換することもできます。

### Q: 変換後にパフォーマンスに影響はありますか？
A: 文字列型の比較は数値型よりも若干遅くなる可能性がありますが、適切なインデックスを設定することで最小限に抑えられます。一方で、型の一貫性が保たれることでJOIN操作のパフォーマンスが向上する場合もあります。