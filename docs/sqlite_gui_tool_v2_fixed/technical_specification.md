# SQLite GUI Tool v2 技術仕様書

## 1. 概要

SQLite GUI Tool v2は、SQLiteデータベースを操作・管理するためのグラフィカルユーザーインターフェースツールです。
このツールは、データベースの閲覧、編集、インポート、エクスポート、分析などの操作をGUIから簡単に行うことができます。
特に、日本語テーブル名の自動変換やコードフィールドの型変換など、日本語環境での利用に配慮した機能を提供しています。

## 2. システム要件

### 2.1 動作環境

- **OS**: Windows, macOS, Linux
- **Python**: 3.8以上
- **必須ライブラリ**:
  - tkinter: GUIフレームワーク
  - sqlite3: SQLiteデータベース操作
  - pandas: データ処理
  - pathlib: パス操作
  - re: 正規表現処理
- **オプションライブラリ**:
  - pyperclip: クリップボード操作

### 2.2 ファイル構成

```
project/
├── src/
│   ├── core/
│   │   ├── sqlite_gui_tool_v2_fixed.py  # メインのGUIツールコード
│   │   ├── sqlite_manager.py            # SQLiteデータベース操作の基本クラス
│   │   └── code_field_converter.py      # コードフィールド変換機能
│   └── ...
├── config/
│   └── constants.py                     # 定数定義（パスなど）
├── data/
│   ├── raw/                             # 入力データファイル
│   └── sqlite/                          # SQLiteデータベースファイル
├── docs/
│   └── sqlite_gui_tool_v2_fixed/        # ドキュメント
│       ├── README.md                    # 基本的な使い方
│       └── technical_specification.md   # 技術仕様書
└── logs/                                # ログファイル
```

## 3. アーキテクチャ

### 3.1 設計パターン

- **MVCパターン**:
  - Model: SQLiteデータベース（sqlite3）
  - View: tkinterウィジェット
  - Controller: イベントハンドラ（SQLiteGUIToolクラス）

- **タブベースUI**:
  - 機能ごとにタブで分離
  - 各タブは独立して初期化・更新される

- **イベント駆動**:
  - ユーザーアクションに応じた処理
  - コールバック関数による非同期処理

### 3.2 クラス構造

#### 3.2.1 SQLiteGUITool クラス

メインのGUIアプリケーションクラス。tkinterウィジェットの初期化と各種イベントハンドラを提供します。

**主要メソッド**:
- `__init__(self, root)`: GUIの初期化
- `init_*_tab(self)`: 各タブの初期化
- `connect_database(self)`: データベース接続
- `update_tabs_after_connection(self)`: データベース接続後のタブ更新
- `save_config(self, config_data)`: 設定の保存
- `load_config(self)`: 設定の読み込み

#### 3.2.2 SQLiteManager クラス (外部依存)

SQLiteデータベースの操作を行うクラス。ファイルの読み込みやデータベースへの書き込みを担当します。

#### 3.2.3 ユーティリティ関数

- `sanitize_table_name(table_name)`: テーブル名を適切に変換

## 4. 機能詳細

### 4.1 データベース接続

**機能概要**:
- SQLiteデータベースファイルに接続
- 接続情報の保存と読み込み
- 接続後の各タブの更新

**実装詳細**:
- `connect_database()` メソッドでファイル選択ダイアログを表示
- sqlite3.connectでデータベースに接続
- 接続情報をJSON形式で保存
- 接続成功時にテーブル一覧を取得し、各タブを更新

**エラーハンドリング**:
- 接続エラー時にメッセージボックスを表示
- トレースバックをコンソールに出力

### 4.2 クエリ実行タブ

**機能概要**:
- SQLクエリの入力と実行
- クエリ結果の表示
- 結果のコピーとエクスポート
- サンプルクエリの提供

**実装詳細**:
- `execute_query()` メソッドでクエリを実行
- 結果をツリービューに表示
- 実行時間と行数を表示
- クエリ例ダイアログの提供

**サンプルクエリ**:
- テーブル一覧表示
- テーブルスキーマ表示
- テーブルデータ表示
- カラム値の分布確認
- NULL値の確認
- テーブル結合

### 4.3 スキーマタブ

**機能概要**:
- テーブル一覧の表示
- テーブル構造の表示（カラム情報、インデックス情報）
- CREATE文の表示
- サンプルデータの表示

**実装詳細**:
- `on_table_select()` メソッドでテーブル選択時の処理
- `show_table_info()` メソッドでテーブル情報を表示
- `show_column_info()` メソッドでカラム情報を表示
- `show_index_info()` メソッドでインデックス情報を表示
- `show_create_sql()` メソッドでCREATE文を表示
- `show_sample_data()` メソッドでサンプルデータを表示

**表示情報**:
- テーブル名
- 行数、カラム数
- カラム定義（名前、データ型、制約など）
- インデックス情報（名前、ユニーク制約、対象カラム）

### 4.4 インポートタブ

**機能概要**:
- CSV、TSV、Excelファイルからデータをインポート
- インポート設定の指定
- データのプレビュー
- テーブル名の自動変換

**実装詳細**:
- `browse_import_file()` メソッドでファイル選択
- `preview_import_data()` メソッドでデータプレビュー
- `execute_import()` メソッドでデータインポート
- `on_table_name_change()` メソッドでテーブル名変更時の処理

**インポート設定**:
- ファイルタイプ（CSV、TSV、Excel）
- エンコーディング（自動検出、utf-8、cp932、shift_jis、euc_jp）
- 区切り文字（自動検出、カンマ、タブ、セミコロン、パイプ）
- ヘッダー行の有無
- テーブル名
- 既存テーブルの処理方法（置換、追加、エラー）

### 4.5 エクスポートタブ

**機能概要**:
- テーブルデータをCSVまたはExcelファイルにエクスポート
- SQLクエリ結果のエクスポート
- エクスポート設定の指定
- データのプレビュー

**実装詳細**:
- `toggle_export_method()` メソッドでエクスポート方法の切り替え
- `preview_export_data()` メソッドでデータプレビュー
- `execute_export()` メソッドでデータエクスポート
- `browse_export_path()` メソッドで出力先選択

**エクスポート設定**:
- エクスポート方法（テーブル全体、SQLクエリ結果）
- 出力形式（CSV、Excel）
- エンコーディング（utf-8、utf-8-sig、cp932、shift_jis）
- 出力先ファイルパス

### 4.6 データ分析タブ

**機能概要**:
- テーブルデータの基本統計分析
- 頻度分布分析
- NULL値チェック
- 重複値チェック

**実装詳細**:
- `on_analyze_table_select()` メソッドでテーブル選択時の処理
- `execute_analysis()` メソッドで分析実行
- `analyze_basic_stats()` メソッドで基本統計分析
- `analyze_frequency_distribution()` メソッドで頻度分布分析
- `analyze_null_values()` メソッドでNULL値チェック
- `analyze_duplicate_values()` メソッドで重複値チェック

**分析タイプ**:
- **基本統計**: 行数、ユニーク値数、最小値、最大値、平均値、合計値、中央値、四分位数
- **頻度分布**: カラム値の出現頻度と割合
- **NULL値チェック**: NULL値の数と割合、NULL値を含む行のサンプル
- **重複値チェック**: 重複値の数と割合、重複値の分布

### 4.7 コードフィールド変換タブ

**機能概要**:
- 数値型として保存されているコードフィールドを文字列型に変換
- 変換対象フィールドの自動検出
- 変換対象フィールドの選択
- 変換の実行

**実装詳細**:
- `analyze_code_fields()` メソッドで変換対象フィールドを分析
- `toggle_field_selection()` メソッドでフィールド選択の切り替え
- `select_all_fields()` メソッドで全フィールド選択
- `deselect_all_fields()` メソッドで全フィールド選択解除
- `convert_selected_fields()` メソッドで選択フィールドの変換

**変換対象の検出基準**:
- カラム名に「コード」「code」などの文字列を含む
- 数値型（INTEGER、REAL）で保存されている
- 先頭に0を持つ値や特殊な形式（例：「1234-」）を含む

## 5. データ処理

### 5.1 テーブル名の変換

**機能概要**:
- 日本語や特殊文字を含むテーブル名をSQLite互換の名前に変換

**実装詳細**:
- `sanitize_table_name()` 関数で変換
- 日本語文字を含む場合は `t_` プレフィックスとハッシュ値を付与
- 英数字以外の文字を `_` に置換
- 先頭が数字の場合は `t_` プレフィックスを付与

**変換例**:
- 「商品マスタ」→「t_1234」（ハッシュ値は例）
- 「item-master」→「item_master」
- 「123_table」→「t_123_table」

### 5.2 データ型の最適化

**機能概要**:
- コードフィールドの文字列型への変換
- 日付データの適切な処理

**実装詳細**:
- `analyze_numeric_code_fields()` 関数で変換対象を検出
- `convert_table_column()` 関数でカラムのデータ型を変換
- 一時テーブルを使用したスキーマ変更

**変換対象の例**:
- 先頭に0を持つコード値（例：「001」→「1」）
- SAPの後ろマイナス表記（例：「1234-」）
- テーブル間で型が不一致のコードフィールド

## 6. エラーハンドリング

### 6.1 例外処理

**実装詳細**:
- try-except構文による例外捕捉
- messagebox.showerrorによるエラーメッセージ表示
- traceback.format_exc()によるスタックトレース取得
- ステータスバーへのエラー状態表示

### 6.2 ログ出力

**実装詳細**:
- print()によるコンソールログ出力
- traceback.format_exc()によるスタックトレース出力

## 7. 設定管理

### 7.1 設定ファイル

**機能概要**:
- アプリケーション設定のJSON形式での保存と読み込み

**実装詳細**:
- `save_config()` メソッドで設定を保存
- `load_config()` メソッドで設定を読み込み
- CONFIG_FILE定数で設定ファイルパスを指定

**保存される設定**:
- 最後に接続したデータベースパス

## 8. パフォーマンス最適化

### 8.1 大量データ処理

**実装詳細**:
- プレビュー時のデータ制限（最大100行）
- 列幅の自動調整（最大文字数の制限）
- 長いテキストの省略表示

### 8.2 メモリ使用量の最適化

**実装詳細**:
- 大きなデータセットの分割処理
- 不要なデータの明示的な削除

## 9. ユーザーインターフェース

### 9.1 レイアウト

**実装詳細**:
- タブコントロールによる機能分離
- 各タブ内での論理的なウィジェット配置
- スクロールバーの適切な配置

### 9.2 ウィジェット

**主要ウィジェット**:
- ttk.Notebook: タブコントロール
- ttk.Frame: フレーム
- ttk.LabelFrame: ラベル付きフレーム
- ttk.Button: ボタン
- ttk.Entry: テキスト入力
- ttk.Combobox: ドロップダウンリスト
- ttk.Radiobutton: ラジオボタン
- ttk.Checkbutton: チェックボックス
- ttk.Treeview: ツリービュー（表形式データ表示）
- tk.Text: 複数行テキスト入力
- tk.Listbox: リストボックス

## 10. 拡張性

### 10.1 新機能の追加

新しいタブや機能を追加する場合は、以下の手順で実装します：

1. `init_new_tab()` メソッドを追加
2. タブコントロールに新しいタブを追加
3. `update_tabs_after_connection()` メソッドに新タブの更新処理を追加

### 10.2 外部連携

外部ツールやライブラリとの連携は、以下の方法で実装できます：

1. 必要なライブラリをインポート
2. try-except構文で依存関係をチェック
3. 機能が利用可能な場合のみUIを有効化

## 11. 制限事項と注意点

### 11.1 メモリ使用量

- 大量データの処理時はメモリ使用量に注意
- 特に大きなファイルのインポート/エクスポート時に注意

### 11.2 データ変更の永続性

- データベースファイルの変更前にバックアップを推奨
- コードフィールド変換は元に戻せない操作

### 11.3 依存ライブラリ

- pyperclipがインストールされていない場合、クリップボードコピー機能は無効
- pandasがインストールされていない場合、一部のデータ処理機能が制限される

## 12. 今後の改善点

### 12.1 機能拡張

- データベースバックアップ機能
- SQLクエリの履歴管理
- データ可視化（グラフ表示）
- 外部データベースへの接続（MySQL、PostgreSQLなど）

### 12.2 パフォーマンス改善

- 大量データ処理の最適化
- 非同期処理の導入
- キャッシュ機構の実装

### 12.3 UI/UX改善

- ダークモード対応
- カスタムテーマ
- キーボードショートカット
- ドラッグ&ドロップ対応